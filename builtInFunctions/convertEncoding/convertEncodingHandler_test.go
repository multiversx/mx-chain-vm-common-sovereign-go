package convertEncoding

import (
	convertCommon "github.com/multiversx/mx-chain-vm-common-go/builtInFunctions/convertEncoding/common"
	"github.com/multiversx/mx-chain-vm-common-go/builtInFunctions/convertEncoding/mvx"
	"github.com/stretchr/testify/require"
	"testing"
)

const ethComplexSignatureMvxEncodedData = "112233445512378899aabbccddeeff000000000000000000@0000000000000000000000001234567890123456789012345678901234567890@12345678901234@112233445566778899aabbccddeeff000000000000000000@01@000000016400000001c8@000000030000000101000000010200000001030100000003abcdef0000000000000000000000000987654321098765432109876543210987654321@00000000000000000000000011111111111111111111111111111111111111110000000000000000000000002222222222222222222222222222222222222222@48656c6c6f2c20576f726c6421@000000010a0000000114000000011e@00000002aaa000000002bbb000000002ccc0@010001@000000010100000001ff000000010200000001fe000000010300000001fd@00000002000000010400000001050000000002123400000000000000000000000033333333333333333333333333333333333333330000000200000001060000000107010000000256780000000000000000000000004444444444444444444444444444444444444444@000000010100000001020000000103000000010400000001050000000106@000000010100000001020000000103000000010400000001050000000106000000010700000001080000000109000000010a@000000010100000003abcdef010000000000000000000000005555555555555555555555555555555555555555000000010200000003123456000000000000000000000000006666666666666666666666666666666666666666000000010300000003789abc010000000000000000000000007777777777777777777777777777777777777777000000010400000003def123000000000000000000000000008888888888888888888888888888888888888888000000010500000003456789010000000000000000000000009999999999999999999999999999999999999999000000010600000003789def00000000000000000000000000aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa@000000010100000003abcdef0100000002000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb0000000164000000000000000000000000cccccccccccccccccccccccccccccccccccccccc00000001c8@0000000102000000031234560000000002000000000000000000000000dddddddddddddddddddddddddddddddddddddddd00000002012c000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000020190000000010300000003789abc0100000002000000000000000000000000ffffffffffffffffffffffffffffffffffffffff0000000201f40000000000000000000000001111111111111111111111111111111111111111000000020258"

const mvxComplexSignature1EthEncodedData = "0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000001e2400000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000186a0fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff830000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000066000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000000000000000000000000000000000000076000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000008e000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000e600000000000000000000000000000000000000000000000000000000000000fc0000000000000000000000000000000000000000000000000000000000000124000000000000000000000000000000000000000000000000000000000000013200000000000000000000000000000000000000000000000000000000000001460000000000000000000000000000000000000000000000000000000000000000212340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000076578616d706c65000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007b00000000000000000000000000000000000000000000000000000000000001c80000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002567800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029abc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000493e0fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff060000000000000000000000000000000000000000000000000000000000007a120ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe890000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000047465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000008ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdcd8ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd8f0ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd508000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002def0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021234000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000256780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029abc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002def0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021234000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000278900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000003150000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000037a0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000002abcd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000038500000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000002ef010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000ea000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001300000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000002345600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000017"

func TestEthereumToMultiversXEncoding(t *testing.T) {
	testEthereumToMultiversXEncoding(t, convertCommon.MvxComplexSignature1, mvxComplexSignature1EthEncodedData)
}

func TestMultiversXToEthereumEncoding(t *testing.T) {
	testMultiversXToEthereumEncoding(t, convertCommon.EthComplexSignature, ethComplexSignatureMvxEncodedData)
}

func testEthereumToMultiversXEncoding(t *testing.T, signature string, hexData string) {
	handler := buildDefaultHandler()
	inputData, err := mvx.Serializer.DecodeIntoParts(hexData)
	require.NoError(t, err)
	converted, err := handler.EthToMvxEncodingWithMvxSignature(signature, inputData)
	require.NoError(t, err)
	require.NotEmpty(t, converted)
	reverted, err := handler.MvxToEthEncodingWithMvxSignature(signature, converted)
	require.NoError(t, err)
	require.NotEmpty(t, reverted)
	revertedHexData := mvx.Serializer.EncodeParts(reverted)
	require.Equal(t, hexData, revertedHexData)
}

func testMultiversXToEthereumEncoding(t *testing.T, signature string, hexData string) {
	handler := buildDefaultHandler()
	inputData, err := mvx.Serializer.DecodeIntoParts(hexData)
	require.NoError(t, err)
	converted, err := handler.MvxToEthEncodingWithEthSignature(signature, inputData)
	require.NoError(t, err)
	require.NotEmpty(t, converted)
	reverted, err := handler.EthToMvxEncodingWithEthSignature(signature, converted)
	require.NoError(t, err)
	require.NotEmpty(t, reverted)
	revertedHexData := mvx.Serializer.EncodeParts(reverted)
	require.Equal(t, hexData, revertedHexData)
}

func buildDefaultHandler() *Handler {
	return NewHandler(convertCommon.BuildTestEncodingContext().Accounts)
}
